{% extends "base.html" %}

{% block title %}Campaigns - Meta Ads Automation{% endblock %}
{% block page_title %}Campaigns{% endblock %}
{% block page_subtitle %}
    <span>Manage your Meta advertising campaigns and automation rules</span>
{% endblock %}

{% block extra_css %}
<style>
    .campaigns-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .campaigns-filters {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        color: #374151;
        min-width: 120px;
    }

    .filter-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }



    /* Campaign Summary Cards */
    .campaign-summary-cards {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        width: 100%;
    }

    .summary-card {
        flex: 1;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px 20px;
        text-align: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        position: relative;
        overflow: hidden;
    }

    .summary-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #ef4444, #dc2626);
        transition: all 0.3s ease;
    }

    .summary-card.revenue::before {
        background: linear-gradient(90deg, #10b981, #059669);
    }

    .summary-card.roas::before {
        background: linear-gradient(90deg, #8b5cf6, #7c3aed);
    }

    .summary-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
        border-color: #cbd5e1;
    }

    .summary-card:hover::before {
        height: 6px;
    }

    .summary-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
        margin: 0 auto 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .summary-card.spend .summary-icon {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .summary-card.revenue .summary-icon {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .summary-card.roas .summary-icon {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    /* CRITICAL: API Status Indicator Styling */
    .summary-card.api-status {
        border-left: 4px solid #ef4444;
        background: #fef2f2;
        animation: pulse-error 2s infinite;
    }

    .summary-card.api-status::before {
        background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    .summary-card.api-status .summary-icon {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    @keyframes pulse-error {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    .summary-content {
        width: 100%;
    }

    .summary-title {
        font-size: 12px;
        font-weight: 600;
        color: #475569;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .summary-value {
        font-size: 24px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 4px;
        line-height: 1;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .summary-period {
        font-size: 11px;
        color: #64748b;
        font-weight: 500;
        background: #f1f5f9;
        padding: 3px 8px;
        border-radius: 12px;
        display: inline-block;
    }

    @media (max-width: 768px) {
        .campaign-summary-cards {
            flex-direction: column;
            gap: 12px;
        }

        .summary-card {
            padding: 14px 16px;
        }

        .summary-value {
            font-size: 20px;
        }

        .summary-icon {
            width: 36px;
            height: 36px;
            font-size: 16px;
            margin-bottom: 8px;
        }
    }

    /* Campaigns Count */
    .campaigns-count-container {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 12px;
    }

    .campaigns-count {
        font-size: 14px;
        color: #64748b;
        font-weight: 600;
        background: #f1f5f9;
        padding: 6px 12px;
        border-radius: 20px;
        border: 1px solid #e2e8f0;
    }

    .campaigns-table-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        overflow: hidden;
        position: relative;
    }

    .campaigns-table {
        width: 100%;
        border-collapse: collapse;
    }

    .campaigns-table th {
        background: #f8fafc;
        padding: 16px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        font-size: 14px;
        border-bottom: 1px solid #e2e8f0;
        white-space: nowrap;
    }

    .campaigns-table td {
        padding: 16px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .campaigns-table tr:hover {
        background: #f8fafc;
    }

    .campaign-name {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 4px;
    }

    .campaign-id {
        font-size: 12px;
        color: #64748b;
        font-family: monospace;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.active {
        background: #dcfce7;
        color: #166534;
    }

    .status-badge.paused {
        background: #fef3c7;
        color: #92400e;
    }

    .status-badge.inactive {
        background: #f3f4f6;
        color: #6b7280;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-indicator.active {
        background: #10b981;
    }

    .status-indicator.paused {
        background: #f59e0b;
    }

    .status-indicator.inactive {
        background: #6b7280;
    }

    .metric-value {
        font-weight: 600;
        color: #1e293b;
    }

    .metric-label {
        font-size: 12px;
        color: #64748b;
        margin-top: 2px;
    }

    .roas-value {
        font-weight: 600;
    }

    .roas-value.good {
        color: #059669;
    }

    .roas-value.average {
        color: #d97706;
    }

    .roas-value.poor {
        color: #dc2626;
    }

    .profit-positive {
        color: #10b981;
    }

    .profit-negative {
        color: #ef4444;
    }

    /* Real-time update animations */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .status-badge {
        transition: all 0.3s ease;
    }

    .status-badge.active {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }

    .status-badge.paused {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
    }

    /* Automation Status Indicator */
    .automation-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #94a3b8;
        animation: pulse-slow 2s infinite;
    }

    .status-indicator.running {
        background: #10b981;
        animation: pulse-fast 1s infinite;
    }

    .status-indicator.stopped {
        background: #ef4444;
        animation: none;
    }

    @keyframes pulse-slow {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    @keyframes pulse-fast {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.2); }
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* Campaign Stats */
    .campaign-stats {
        display: flex;
        gap: 20px;
        padding: 8px 16px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .stat-number {
        font-size: 20px;
        font-weight: 700;
        color: #1e293b;
        line-height: 1;
    }

    .stat-label {
        font-size: 11px;
        font-weight: 500;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 2px;
    }

    .refresh-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .refresh-btn:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-1px);
    }

    .match-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .match-badge.id-match {
        background: #dcfce7;
        color: #166534;
    }

    .match-badge.name-match {
        background: #dbeafe;
        color: #1e40af;
    }

    .match-badge.no-match {
        background: #f3f4f6;
        color: #6b7280;
    }

    .campaign-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .action-button {
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        color: #374151;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .action-button:hover {
        border-color: #3b82f6;
        color: #3b82f6;
        background: #f8fafc;
    }

    .action-button.toggle-pause {
        border-color: #f59e0b;
        color: #f59e0b;
        font-weight: 700;
        padding: 8px 16px;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
    }

    .action-button.toggle-pause:hover {
        background: #f59e0b;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
    }

    .action-button.toggle-activate {
        border-color: #10b981;
        color: #10b981;
        font-weight: 700;
        padding: 8px 16px;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }

    .action-button.toggle-activate:hover {
        background: #10b981;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    }

    .action-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    /* Toggle Switch Styles */
    .campaign-toggle {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
        margin-right: 12px;
    }

    .campaign-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ef4444;
        transition: .3s;
        border-radius: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .campaign-toggle input:checked + .toggle-slider {
        background-color: #10b981;
    }

    .campaign-toggle input:checked + .toggle-slider:before {
        transform: translateX(30px);
    }

    .toggle-slider:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Campaign Details Dropdown */
    .campaign-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .campaign-row:hover {
        background: #f8fafc;
    }

    .campaign-expand-icon {
        transition: transform 0.2s ease;
        color: #64748b;
        margin-right: 8px;
        cursor: pointer;
    }

    .campaign-expand-icon.expanded {
        transform: rotate(90deg);
    }

    .campaign-details-row {
        display: none;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
    }

    .campaign-details-row.show {
        display: table-row;
    }

    .campaign-details-content {
        padding: 20px;
        border-left: 4px solid #3b82f6;
    }

    .details-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 16px;
    }

    @media (max-width: 768px) {
        .details-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .details-grid {
            grid-template-columns: 1fr;
        }
    }

    .detail-item {
        background: white;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .detail-label {
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .detail-value {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
    }

    .campaign-objective {
        display: inline-block;
        padding: 4px 8px;
        background: #dbeafe;
        color: #1e40af;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* Rules Dropdown */
    .rules-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e2e8f0;
    }

    .rules-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .rules-dropdown-container {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .rules-select {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        color: #374151;
        min-width: 200px;
    }

    .rules-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .assign-rule-btn {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .assign-rule-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .assign-rule-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .assigned-rules {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .assigned-rule-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        background: #dcfce7;
        color: #166534;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .remove-rule-btn {
        background: none;
        border: none;
        color: #dc2626;
        cursor: pointer;
        padding: 0;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
    }

    .remove-rule-btn:hover {
        background: #fecaca;
    }

    .rules-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #64748b;
    }

    .rules-count {
        background: #3b82f6;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 600;
        min-width: 18px;
        text-align: center;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }

    .empty-state i {
        font-size: 64px;
        color: #cbd5e1;
        margin-bottom: 20px;
    }

    .empty-state h3 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #374151;
    }

    .empty-state p {
        font-size: 16px;
        margin-bottom: 24px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        display: none;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .campaigns-header {
            flex-direction: column;
            align-items: stretch;
        }

        .campaigns-filters {
            justify-content: space-between;
        }

        .campaigns-table-container {
            overflow-x: visible;
        }

        .campaigns-table {
            width: 100%;
            table-layout: fixed;
        }

        .campaigns-table th,
        .campaigns-table td {
            padding: 8px 4px;
            font-size: 12px;
        }

        .campaign-name {
            font-size: 12px;
        }

        .campaign-id {
            font-size: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="campaigns-header">
    <div class="campaigns-filters">
        <select class="filter-select" id="statusFilter" onchange="handleFilterChange('status')">
            <option value="">All Statuses</option>
            <option value="ACTIVE">Active</option>
            <option value="PAUSED">Paused</option>
        </select>

        <select class="filter-select" id="dateFilter" onchange="handleFilterChange('date')">
            <option value="last_30_days">Last 30 Days</option>
            <option value="last_7_days">Last 7 Days</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
        </select>

        <select class="filter-select" id="matchFilter" onchange="handleFilterChange('match')">
            <option value="">All Tracking</option>
            <option value="ID Match">ID Match</option>
            <option value="Name Match">Name Match</option>
            <option value="No Match">No Match</option>
        </select>
    </div>

    <div class="header-actions">
        <div class="campaign-stats" id="campaignStats">
            <div class="stat-item">
                <span class="stat-number" id="totalCampaigns">0</span>
                <span class="stat-label">Total Campaigns</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="activeCampaigns">0</span>
                <span class="stat-label">Active Campaigns</span>
            </div>
        </div>
        <div class="automation-status" id="automationStatus">
            <span class="status-indicator"></span>
            <span>Checking automation...</span>
        </div>
        <button onclick="refreshCampaigns()" class="refresh-btn" id="refreshBtn">
            <i class="fas fa-sync-alt"></i>
            Refresh
        </button>
    </div>

</div>

<!-- Campaign Summary Cards -->
<div class="campaign-summary-cards">
    <div class="summary-card spend">
        <div class="summary-icon">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="summary-content">
            <div class="summary-title">Total Spend</div>
            <div class="summary-value" id="totalSpendValue">$0.00</div>
            <div class="summary-period" id="spendPeriodLabel">Selected period</div>
        </div>
    </div>

    <div class="summary-card revenue">
        <div class="summary-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="summary-content">
            <div class="summary-title">Total Revenue</div>
            <div class="summary-value" id="totalRevenueValue">$0.00</div>
            <div class="summary-period" id="revenuePeriodLabel">Selected period</div>
        </div>
    </div>

    <div class="summary-card roas">
        <div class="summary-icon">
            <i class="fas fa-percentage"></i>
        </div>
        <div class="summary-content">
            <div class="summary-title">ROAS</div>
            <div class="summary-value" id="totalRoasValue">0.0%</div>
            <div class="summary-period" id="roasPeriodLabel">Selected period</div>
        </div>
    </div>

    <!-- CRITICAL: RedTrack API Status Indicator -->
    <div class="summary-card api-status" id="redtrackStatus" style="display: none;">
        <div class="summary-icon">
            <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
        </div>
        <div class="summary-content">
            <div class="summary-title">RedTrack API</div>
            <div class="summary-value" style="color: #ef4444; font-size: 14px;">NOT CONNECTED</div>
            <div class="summary-period">Revenue data incomplete</div>
        </div>
    </div>
</div>

<!-- Total Campaigns Count -->
<div class="campaigns-count-container">
    <span class="campaigns-count" id="campaignsCount">0 campaigns</span>
</div>

<div class="campaigns-table-container">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div id="campaignsContent">
        <div class="empty-state">
            <i class="fas fa-bullhorn"></i>
            <h3>No Campaigns Found</h3>
            <p>Load your Meta ad accounts to see campaigns and start automation</p>
            <button class="btn-primary" onclick="loadAccountsAndCampaigns()">Load Campaigns</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allCampaigns = [];
    let campaignsCache = {};
    let lastLoadTime = 0;
    const CACHE_DURATION = 30000; // 30 seconds cache

    // Load campaigns on page load
    // Global cache for fast loading
    let globalCachedData = null;

    // Auto-refresh interval variable
    let autoRefreshInterval = null;

    document.addEventListener('DOMContentLoaded', function() {
        // ENHANCED: Restore filter state on page load
        console.log('🔄 Restoring filter state on page load...');
        const restoredFilters = restoreFilterState();

        // Set up refresh button
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => refreshAllData(true));
        }

        // Load campaigns using optimized method (will use restored date filter)
        loadCampaignsOptimized();

        // Start auto-refresh every 30 seconds with filter preservation
        console.log('🚀 Initializing auto-refresh system...');
        startAutoRefresh();

        // Initial automation status check
        updateAutomationStatus();

        // Force first auto-refresh after 2 seconds to test
        setTimeout(() => {
            console.log('🔄 Testing auto-refresh...');
            autoRefreshWithFilters();
        }, 2000);

        // Start instant rule checking every 10 seconds for missed triggers
        setInterval(() => {
            console.log('⚡ Periodic instant rule check...');
            fetch('/dashboard/api/campaigns/instant-rule-check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('⚡ Periodic rule check completed');
                    // Check for any changes after rule check
                    setTimeout(() => autoRefreshWithFilters(), 1000);
                }
            })
            .catch(error => {
                console.error('⚡ Periodic rule check error:', error);
            });
        }, 10000); // Every 10 seconds
    });

    // Start automatic refresh every 10 seconds maximum for real-time updates
    function startAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }

        autoRefreshInterval = setInterval(() => {
            console.log('🔄 Auto-refreshing campaigns data...');
            showAutoRefreshIndicator();
            autoRefreshWithFilters();
        }, 30000); // 30 seconds as requested

        console.log('✅ Auto-refresh started (every 30 seconds)');

        // Also update automation status
        updateAutomationStatus();
    }

    // Show visual indicator when auto-refresh happens
    function showAutoRefreshIndicator() {
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.style.animation = 'pulse 0.5s ease-in-out';
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Auto-Refreshing...';

            setTimeout(() => {
                refreshBtn.style.animation = '';
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            }, 2000);
        }
    }

    // Update automation status indicator
    function updateAutomationStatus() {
        fetch('/dashboard/api/automation/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const statusElement = document.getElementById('automationStatus');
                    const indicator = statusElement.querySelector('.status-indicator');
                    const text = statusElement.querySelector('span:last-child');

                    if (data.status.is_running) {
                        indicator.className = 'status-indicator running';
                        text.textContent = `Rules Active (${data.status.active_rules} rules)`;
                    } else {
                        indicator.className = 'status-indicator stopped';
                        text.textContent = 'Rules Inactive';
                    }
                }
            })
            .catch(error => {
                console.error('Error updating automation status:', error);
            });
    }

    // ENHANCED: Auto-refresh with ALL filter preservation
    function autoRefreshWithFilters() {
        // Store current filter values BEFORE making any API calls
        const currentFilters = {
            status: document.getElementById('statusFilter').value,
            match: document.getElementById('matchFilter').value,
            date: document.getElementById('dateFilter').value
        };

        console.log('🔄 Starting auto-refresh with ALL filters preserved:', currentFilters);

        // Use the campaigns list endpoint with proper date range parameter
        fetch(`/dashboard/api/campaigns/list?date_range=${currentFilters.date}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const newCampaigns = data.campaigns || [];
                    console.log(`📊 Received ${newCampaigns.length} campaigns from API for ${currentFilters.date}`);

                    // Update global campaigns data
                    allCampaigns = newCampaigns;

                    // CRITICAL: Restore ALL filter values IMMEDIATELY after data update
                    const statusFilter = document.getElementById('statusFilter');
                    const matchFilter = document.getElementById('matchFilter');
                    const dateFilter = document.getElementById('dateFilter');

                    if (statusFilter) statusFilter.value = currentFilters.status;
                    if (matchFilter) matchFilter.value = currentFilters.match;
                    if (dateFilter) dateFilter.value = currentFilters.date;

                    // Update campaign values in the table (but don't render yet)
                    updateCampaignValues(newCampaigns);

                    // Update period labels to match current date filter
                    updatePeriodLabels();

                    // IMPORTANT: Apply filters AFTER restoring filter values
                    // This ensures the correct campaigns are shown based on ALL filters
                    applyAllFilters();

                    // Update campaign stats based on FILTERED campaigns
                    const filteredCampaigns = getFilteredCampaigns();
                    updateCampaignStats(filteredCampaigns);

                    console.log(`✅ Auto-refresh completed - ${newCampaigns.length} total campaigns, showing filtered results for: Status=${currentFilters.status || 'All'}, Match=${currentFilters.match || 'All'}, Date=${currentFilters.date}`);
                } else {
                    console.error('❌ Auto-refresh failed:', data.error);
                }
            })
            .catch(error => {
                console.error('❌ Auto-refresh error:', error);
            });
    }

    // Helper function to get currently filtered campaigns
    function getFilteredCampaigns() {
        const statusFilter = document.getElementById('statusFilter').value;
        const matchFilter = document.getElementById('matchFilter').value;

        let filteredCampaigns = allCampaigns;

        if (statusFilter) {
            filteredCampaigns = filteredCampaigns.filter(c => c.status === statusFilter);
        }

        if (matchFilter) {
            filteredCampaigns = filteredCampaigns.filter(c => c.match_type === matchFilter);
        }

        return filteredCampaigns;
    }

    // ENHANCED: Filter persistence functions
    function saveFilterState() {
        const filterState = {
            status: document.getElementById('statusFilter').value,
            match: document.getElementById('matchFilter').value,
            date: document.getElementById('dateFilter').value
        };

        localStorage.setItem('campaignFilters', JSON.stringify(filterState));
        console.log('💾 Filter state saved:', filterState);
    }

    function restoreFilterState() {
        try {
            const savedFilters = localStorage.getItem('campaignFilters');
            if (savedFilters) {
                const filterState = JSON.parse(savedFilters);

                // Restore filter values
                if (filterState.status !== undefined) {
                    document.getElementById('statusFilter').value = filterState.status;
                }
                if (filterState.match !== undefined) {
                    document.getElementById('matchFilter').value = filterState.match;
                }
                if (filterState.date !== undefined) {
                    document.getElementById('dateFilter').value = filterState.date;
                }

                console.log('🔄 Filter state restored:', filterState);
                return filterState;
            }
        } catch (error) {
            console.error('❌ Error restoring filter state:', error);
        }
        return null;
    }

    // Fast live update function for real-time status changes
    function updateCampaignValuesLive(liveCampaigns) {
        liveCampaigns.forEach(liveCampaign => {
            const campaignRow = document.querySelector(`[data-campaign-id="${liveCampaign.id}"]`);
            if (campaignRow) {
                // Update status badge (most important for rule changes)
                const statusBadge = campaignRow.querySelector('.status-badge');
                if (statusBadge && statusBadge.textContent !== liveCampaign.status) {
                    statusBadge.textContent = liveCampaign.status;
                    statusBadge.className = `status-badge ${liveCampaign.status.toLowerCase()}`;

                    // Add visual indicator for status change
                    statusBadge.style.animation = 'pulse 0.5s ease-in-out';
                    setTimeout(() => {
                        statusBadge.style.animation = '';
                    }, 500);
                }

                // Update spend
                const spendCell = campaignRow.querySelector('.campaign-spend');
                if (spendCell) {
                    spendCell.textContent = `$${parseFloat(liveCampaign.spend || 0).toFixed(2)}`;
                }

                // Update revenue
                const revenueCell = campaignRow.querySelector('.campaign-revenue');
                if (revenueCell) {
                    revenueCell.textContent = `$${parseFloat(liveCampaign.revenue || 0).toFixed(2)}`;
                }

                // Update conversions
                const conversionsCell = campaignRow.querySelector('.campaign-conversions');
                if (conversionsCell) {
                    conversionsCell.textContent = liveCampaign.conversions || 0;
                }

                // Update CPA
                const cpaCell = campaignRow.querySelector('.campaign-cpa');
                if (cpaCell) {
                    const cpa = liveCampaign.cpa || 0;
                    cpaCell.textContent = cpa > 0 ? `$${parseFloat(cpa).toFixed(2)}` : '$0.00';
                }

                // Update profit
                const profitCell = campaignRow.querySelector('.campaign-profit');
                if (profitCell) {
                    const profit = (liveCampaign.revenue || 0) - (liveCampaign.spend || 0);
                    profitCell.textContent = `$${profit.toFixed(2)}`;
                    profitCell.className = `campaign-profit ${profit >= 0 ? 'profit-positive' : 'profit-negative'}`;
                }
            }
        });
    }

    // Update campaign values including STATUS automatically (this is the key fix!)
    function updateCampaignValues(newCampaigns) {
        console.log('🔄 Updating campaign values...');

        newCampaigns.forEach(newCampaign => {
            const campaignRow = document.querySelector(`[data-campaign-id="${newCampaign.id}"]`);
            if (campaignRow) {
                console.log(`📊 Updating campaign: ${newCampaign.name} - Status: ${newCampaign.status}`);

                // UPDATE STATUS BADGE - This was missing!
                const statusBadge = campaignRow.querySelector('.status-badge');
                if (statusBadge) {
                    const oldStatus = statusBadge.textContent;
                    statusBadge.textContent = newCampaign.status;
                    statusBadge.className = `status-badge ${newCampaign.status.toLowerCase()}`;

                    // Show visual feedback if status changed
                    if (oldStatus !== newCampaign.status) {
                        console.log(`🔄 Status changed: ${newCampaign.name} from ${oldStatus} to ${newCampaign.status}`);
                        statusBadge.style.animation = 'pulse 0.5s ease-in-out';
                        setTimeout(() => statusBadge.style.animation = '', 500);
                    }
                }

                // Update spend
                const spendCell = campaignRow.querySelector('.campaign-spend');
                if (spendCell) {
                    spendCell.textContent = `$${parseFloat(newCampaign.spend || 0).toFixed(2)}`;
                }

                // Update revenue
                const revenueCell = campaignRow.querySelector('.campaign-revenue');
                if (revenueCell) {
                    revenueCell.textContent = `$${parseFloat(newCampaign.revenue || 0).toFixed(2)}`;
                }

                // Update conversions
                const conversionsCell = campaignRow.querySelector('.campaign-conversions');
                if (conversionsCell) {
                    conversionsCell.textContent = newCampaign.conversions || 0;
                }

                // Update profit
                const profitCell = campaignRow.querySelector('.campaign-profit');
                if (profitCell) {
                    const profit = (newCampaign.revenue || 0) - (newCampaign.spend || 0);
                    profitCell.textContent = `$${profit.toFixed(2)}`;
                    profitCell.className = `campaign-profit ${profit >= 0 ? 'profit-positive' : 'profit-negative'}`;
                }

                // Update CPA
                const cpaCell = campaignRow.querySelector('.campaign-cpa');
                if (cpaCell) {
                    const cpa = newCampaign.cpa || 0;
                    cpaCell.textContent = cpa > 0 ? `$${parseFloat(cpa).toFixed(2)}` : '$0.00';
                }

                // Update ROAS if available
                const roasCell = campaignRow.querySelector('.campaign-roas');
                if (roasCell) {
                    const roas = newCampaign.roas || 0;
                    roasCell.textContent = roas > 0 ? `${parseFloat(roas).toFixed(2)}x` : '0.00x';
                }
            }
        });

        console.log('✅ Campaign values updated successfully');
    }

    // ENHANCED: Update campaign stats in header with spend/revenue totals
    function updateCampaignStats(campaigns) {
        const totalCampaigns = campaigns.length;
        const activeCampaigns = campaigns.filter(camp => camp.status === 'ACTIVE').length;

        // Calculate totals from filtered campaigns
        let totalSpend = 0;
        let totalRevenue = 0;
        let redtrackApiWorking = true;  // Assume working until proven otherwise
        let redtrackApiError = null;

        if (campaigns && campaigns.length > 0) {
            campaigns.forEach(campaign => {
                totalSpend += parseFloat(campaign.spend || 0);
                totalRevenue += parseFloat(campaign.revenue || 0);

                // CRITICAL: Check for RedTrack API errors
                if (campaign.redtrack_api_error) {
                    redtrackApiWorking = false;
                    redtrackApiError = campaign.redtrack_api_error;
                }
            });
        }

        // Calculate ROAS
        const roas = totalSpend > 0 ? (totalRevenue / totalSpend * 100) : 0;

        // Update campaign counts
        document.getElementById('totalCampaigns').textContent = totalCampaigns;
        document.getElementById('activeCampaigns').textContent = activeCampaigns;

        // Update spend/revenue totals based on FILTERED campaigns
        document.getElementById('totalSpendValue').textContent = `$${totalSpend.toFixed(2)}`;
        document.getElementById('totalRevenueValue').textContent = `$${totalRevenue.toFixed(2)}`;
        document.getElementById('totalRoasValue').textContent = `${roas.toFixed(1)}%`;

        // CRITICAL: Show/hide RedTrack API status
        updateRedTrackStatus(redtrackApiWorking, redtrackApiError);

        console.log(`📊 Stats updated: ${totalCampaigns} total, ${activeCampaigns} active, $${totalSpend.toFixed(2)} spend, $${totalRevenue.toFixed(2)} revenue, ${roas.toFixed(1)}% ROAS, RedTrack: ${redtrackApiWorking ? 'Working' : 'FAILED'}`);
    }

    // CRITICAL: Update RedTrack API status indicator with error details
    function updateRedTrackStatus(isWorking, errorMessage) {
        const statusCard = document.getElementById('redtrackStatus');
        if (!statusCard) return;

        if (isWorking) {
            statusCard.style.display = 'none';
            console.log('✅ RedTrack API: Working');
        } else {
            statusCard.style.display = 'flex';

            // Update error message if available
            if (errorMessage) {
                const errorElement = statusCard.querySelector('.summary-period');
                if (errorElement) {
                    errorElement.textContent = `Error: ${errorMessage}`;
                }
            }

            console.log(`❌ CRITICAL: RedTrack API FAILED - ${errorMessage || 'Revenue data incomplete'}`);
        }
    }

    // FIXED: Optimized campaigns loading with proper date filtering
    function loadCampaignsOptimized() {
        const dateRange = document.getElementById('dateFilter').value;

        console.log(`🔄 Loading campaigns for date range: ${dateRange}`);
        showLoading(true);

        // Always use the campaigns list endpoint for consistent date filtering
        fetch(`/dashboard/api/campaigns/list?date_range=${dateRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.campaigns) {
                    allCampaigns = data.campaigns || [];

                    // Update period labels
                    updatePeriodLabels();

                    // Apply all filters after loading new data
                    applyAllFilters();

                    // Update campaign stats with FILTERED campaigns
                    const filteredCampaigns = getFilteredCampaigns();
                    updateCampaignStats(filteredCampaigns);

                    console.log(`✅ Loaded ${allCampaigns.length} campaigns for ${dateRange}`);
                } else {
                    console.error('❌ Failed to load campaigns:', data.error);
                    showEmptyState();
                }
            })
            .catch(error => {
                console.error('❌ Error loading campaigns:', error);
                showEmptyState();
            })
            .finally(() => {
                showLoading(false);
            });
    }

    // Load from global cached data
    function loadFromGlobalCache() {
        showLoading(true);

        fetch('/dashboard/api/get-all-data')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    globalCachedData = data.data;
                    allCampaigns = data.data.campaigns || [];

                    // Update stats display
                    updateStatsDisplay(data.data);

                    // Apply all filters after loading new data
                    applyAllFilters();

                    // Update campaign stats with FILTERED campaigns
                    const filteredCampaigns = getFilteredCampaigns();
                    updateCampaignStats(filteredCampaigns);

                    console.log(`✅ Loaded ${allCampaigns.length} campaigns from cache`);
                } else {
                    showEmptyState();
                }
            })
            .catch(error => {
                console.error('Error loading campaigns:', error);
                showEmptyState();
            })
            .finally(() => {
                showLoading(false);
            });
    }

    // ENHANCED: Refresh all data function with ALL filter preservation
    function refreshAllData(force = false) {
        // Store current filter values BEFORE any operations
        const currentFilters = {
            status: document.getElementById('statusFilter').value,
            match: document.getElementById('matchFilter').value,
            date: document.getElementById('dateFilter').value
        };

        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            refreshBtn.disabled = true;
        }

        console.log('🔄 Manual refresh with ALL filters preserved:', currentFilters);

        // Always use the campaigns list endpoint with current date filter
        fetch(`/dashboard/api/campaigns/list?date_range=${currentFilters.date}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allCampaigns = data.campaigns || [];

                    // CRITICAL: Restore ALL filter values immediately
                    const statusFilter = document.getElementById('statusFilter');
                    const matchFilter = document.getElementById('matchFilter');
                    const dateFilter = document.getElementById('dateFilter');

                    if (statusFilter) statusFilter.value = currentFilters.status;
                    if (matchFilter) matchFilter.value = currentFilters.match;
                    if (dateFilter) dateFilter.value = currentFilters.date;

                    // Update period labels
                    updatePeriodLabels();

                    // Apply all filters FIRST to get correct filtered campaigns
                    applyAllFilters();

                    // Update campaign stats based on FILTERED campaigns
                    const filteredCampaigns = getFilteredCampaigns();
                    updateCampaignStats(filteredCampaigns);

                    console.log(`✅ Manual refresh completed - ${allCampaigns.length} total campaigns, showing filtered results for: Status=${currentFilters.status || 'All'}, Match=${currentFilters.match || 'All'}, Date=${currentFilters.date}`);
                } else {
                    console.error('Failed to refresh data:', data.error);
                }
            })
            .catch(error => {
                console.error('Error refreshing data:', error);
            })
            .finally(() => {
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                    refreshBtn.disabled = false;
                }
            });
    }

    // Update stats display
    function updateStatsDisplay(data) {
        // You can add stats display here if needed
        if (data.last_refresh) {
            const refreshTime = new Date(data.last_refresh).toLocaleTimeString();
            console.log(`📊 Campaigns data last refreshed at: ${refreshTime}`);
        }
    }

    // Old method for non-default date ranges
    function loadCampaignsOld(dateRange) {
        showLoading(true);

        fetch(`/dashboard/api/campaigns/${dateRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allCampaigns = data.campaigns || [];
                    applyAllFilters();
                } else {
                    showEmptyState();
                }
            })
            .catch(error => {
                console.error('Error loading campaigns:', error);
                showEmptyState();
            })
            .finally(() => {
                showLoading(false);
            });
    }

    // ENHANCED: Unified filter change handler with persistence
    function handleFilterChange(filterType) {
        console.log(`🔧 ${filterType} filter changed, applying filters...`);

        // Save filter state immediately when any filter changes
        saveFilterState();

        if (filterType === 'date') {
            // For date filter changes, we need to reload data
            console.log('📅 Date filter changed, loading campaigns...');

            // Clear any existing auto-refresh to prevent conflicts
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            // Load campaigns with new date filter
            loadCampaignsOptimized();

            // Restart auto-refresh with new filter
            setTimeout(() => {
                startAutoRefresh();
            }, 1000);
        } else {
            // For status and match filters, just apply filters to existing data
            console.log(`🔧 ${filterType} filter changed, applying to existing data...`);
            filterCampaigns();

            // Update stats with filtered campaigns immediately
            const filteredCampaigns = getFilteredCampaigns();
            updateCampaignStats(filteredCampaigns);
        }
    }

    // LEGACY: Keep for backward compatibility
    function handleDateFilterChange() {
        handleFilterChange('date');
    }

    // Load campaigns with caching (keep for backward compatibility)
    function loadCampaigns() {
        loadCampaignsOptimized();
    }

    // Load accounts and campaigns
    function loadAccountsAndCampaigns() {
        showLoading(true);

        fetch('/dashboard/api/accounts')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.accounts.length > 0) {
                    // Auto-select first account
                    return fetch(`/dashboard/api/set-account/${data.accounts[0].id}`, { method: 'POST' });
                } else {
                    throw new Error('No accounts found');
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    return loadCampaigns();
                } else {
                    throw new Error('Failed to set account');
                }
            })
            .catch(error => {
                console.error('Error loading accounts:', error);
                alert('Error loading accounts. Please check your Meta API connection.');
                showLoading(false);
            });
    }

    // Refresh campaigns (force reload)
    function refreshCampaigns() {
        // Clear cache to force fresh data
        campaignsCache = {};
        lastLoadTime = 0;
        loadCampaigns();

        // Also update stats immediately with FILTERED campaigns
        setTimeout(() => {
            if (allCampaigns && allCampaigns.length > 0) {
                const filteredCampaigns = getFilteredCampaigns();
                updateCampaignStats(filteredCampaigns);
                console.log('📊 Stats updated after manual refresh with filtered campaigns');
            }
        }, 1000);
    }

    // Clear campaigns cache
    function clearCampaignsCache() {
        campaignsCache = {};
        lastLoadTime = 0;
    }

    // ENHANCED: Apply all filters and update stats
    function applyAllFilters() {
        const statusFilter = document.getElementById('statusFilter').value;
        const matchFilter = document.getElementById('matchFilter').value;

        let filteredCampaigns = allCampaigns;

        if (statusFilter) {
            filteredCampaigns = filteredCampaigns.filter(c => c.status === statusFilter);
        }

        if (matchFilter) {
            filteredCampaigns = filteredCampaigns.filter(c => c.match_type === matchFilter);
        }

        // Render campaigns (this also updates summary cards via updateSummaryCards)
        renderCampaigns(filteredCampaigns);

        // Also update the header stats with filtered campaigns
        updateCampaignStats(filteredCampaigns);

        console.log(`🔧 Applied filters: Status=${statusFilter || 'All'}, Match=${matchFilter || 'All'} - Showing ${filteredCampaigns.length} campaigns`);
    }

    // Filter campaigns (called when status or tracking filters change)
    function filterCampaigns() {
        applyAllFilters();
    }



    // Update campaigns count only (totals handled by updateCampaignStats)
    function updateSummaryCards(campaigns) {
        const campaignCount = campaigns ? campaigns.length : 0;

        // Update campaigns count
        const countText = campaignCount === 1 ? '1 campaign' : `${campaignCount} campaigns`;
        document.getElementById('campaignsCount').textContent = countText;

        // Update period labels
        const selectedPeriod = getPeriodLabel();
        document.getElementById('spendPeriodLabel').textContent = selectedPeriod;
        document.getElementById('revenuePeriodLabel').textContent = selectedPeriod;
        document.getElementById('roasPeriodLabel').textContent = selectedPeriod;
    }

    // Get period label for summary cards
    function getPeriodLabel() {
        const dateFilter = document.getElementById('dateFilter').value;
        switch(dateFilter) {
            case 'today': return 'Today';
            case 'yesterday': return 'Yesterday';
            case 'last_7_days': return 'Last 7 days';
            case 'last_30_days': return 'Last 30 days';
            default: return 'Selected period';
        }
    }

    // FIXED: Update period labels to match current date filter
    function updatePeriodLabels() {
        const selectedPeriod = getPeriodLabel();
        const periodElements = document.querySelectorAll('[id$="PeriodLabel"]');

        periodElements.forEach(element => {
            element.textContent = selectedPeriod;
        });

        console.log(`📅 Updated period labels to: ${selectedPeriod}`);
    }

    // Render campaigns table
    function renderCampaigns(campaigns) {
        const content = document.getElementById('campaignsContent');

        // Update summary cards (campaigns count only, totals handled by updateCampaignStats)
        updateSummaryCards(campaigns);

        if (!campaigns || campaigns.length === 0) {
            showEmptyState();
            return;
        }

        const tableHTML = `
            <table class="campaigns-table">
                <thead>
                    <tr>
                        <th>Campaign</th>
                        <th>Status</th>
                        <th>Spend</th>
                        <th>Revenue</th>
                        <th>ROAS</th>
                        <th>Tracking</th>
                        <th>Toggle</th>
                    </tr>
                </thead>
                <tbody>
                    ${campaigns.map(campaign => `
                        <tr class="campaign-row" data-campaign-id="${campaign.id}" onclick="toggleCampaignDetails('${campaign.id}')">
                            <td>
                                <div style="display: flex; align-items: center;">
                                    <i class="fas fa-chevron-right campaign-expand-icon" id="expand-${campaign.id}"></i>
                                    <div>
                                        <div class="campaign-name">${campaign.name}</div>
                                        <div class="campaign-id">${campaign.id}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="status-badge ${campaign.status.toLowerCase()}">
                                    <div class="status-indicator ${campaign.status.toLowerCase()}"></div>
                                    ${campaign.status}
                                </div>
                            </td>
                            <td>
                                <div class="metric-value campaign-spend">$${campaign.spend.toFixed(2)}</div>
                            </td>
                            <td>
                                <div class="metric-value campaign-revenue">$${campaign.revenue.toFixed(2)}</div>
                                <div class="metric-label">${campaign.conversions} conversions</div>
                            </td>
                            <td>
                                <div class="roas-value ${getRoasClass(campaign.roas)}">${campaign.roas}%</div>
                            </td>
                            <td>
                                <div class="match-badge ${getMatchClass(campaign.match_type)}">${campaign.match_type}</div>
                            </td>
                            <td>
                                <div class="campaign-actions" onclick="event.stopPropagation()">
                                    <label class="campaign-toggle" title="Toggle campaign status">
                                        <input type="checkbox" ${campaign.status === 'ACTIVE' ? 'checked' : ''}
                                               onchange="toggleCampaignSwitch('${campaign.id}', this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </td>
                        </tr>
                        <tr class="campaign-details-row" id="details-${campaign.id}">
                            <td colspan="7">
                                <div class="campaign-details-content">
                                    <div class="details-grid">
                                        <div class="detail-item">
                                            <div class="detail-label">Campaign ID</div>
                                            <div class="detail-value">${campaign.id}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Objective</div>
                                            <div class="detail-value">
                                                <span class="campaign-objective">${campaign.objective || 'Unknown'}</span>
                                            </div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Conversions</div>
                                            <div class="detail-value">${campaign.conversions || 0}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">CPA</div>
                                            <div class="detail-value campaign-cpa">$${calculateCPA(campaign).toFixed(2)}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Conversion Rate</div>
                                            <div class="detail-value">${calculateConversionRate(campaign).toFixed(2)}%</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Profit</div>
                                            <div class="detail-value campaign-profit ${calculateProfit(campaign) >= 0 ? 'profit-positive' : 'profit-negative'}">
                                                $${calculateProfit(campaign).toFixed(2)}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="rules-section">
                                        <div class="rules-section-title">
                                            <i class="fas fa-cogs"></i>
                                            Automation Rules
                                        </div>
                                        <div class="rules-dropdown-container">
                                            <select class="rules-select" id="rules-select-${campaign.id}">
                                                <option value="">Select a rule to assign...</option>
                                            </select>
                                            <button class="assign-rule-btn" onclick="assignSelectedRule('${campaign.id}')" id="assign-btn-${campaign.id}">
                                                <i class="fas fa-plus"></i>
                                                Assign Rule
                                            </button>
                                        </div>
                                        <div class="assigned-rules" id="assigned-rules-${campaign.id}">
                                            <!-- Assigned rules will be displayed here -->
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

        content.innerHTML = tableHTML;
    }

    // Show empty state
    function showEmptyState() {
        const content = document.getElementById('campaignsContent');
        content.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bullhorn"></i>
                <h3>No Campaigns Found</h3>
                <p>Load your Meta ad accounts to see campaigns and start automation</p>
                <button class="btn-primary" onclick="loadAccountsAndCampaigns()">Load Campaigns</button>
            </div>
        `;
    }

    // Show/hide loading
    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            overlay.classList.add('show');
        } else {
            overlay.classList.remove('show');
        }
    }

    // Get ROAS class for styling
    function getRoasClass(roas) {
        if (roas >= 200) return 'good';
        if (roas >= 100) return 'average';
        return 'poor';
    }

    // Get match class for styling
    function getMatchClass(matchType) {
        if (matchType === 'ID Match') return 'id-match';
        if (matchType === 'Name Match') return 'name-match';
        return 'no-match';
    }

    // Calculate CPA (Cost Per Acquisition)
    function calculateCPA(campaign) {
        const conversions = campaign.conversions || 0;
        const spend = campaign.spend || 0;
        return conversions > 0 ? spend / conversions : 0;
    }

    // Calculate Conversion Rate
    function calculateConversionRate(campaign) {
        const conversions = campaign.conversions || 0;
        const spend = campaign.spend || 0;
        // Assuming 1000 impressions per $10 spend as a rough estimate
        const estimatedImpressions = spend * 100;
        return estimatedImpressions > 0 ? (conversions / estimatedImpressions) * 100 : 0;
    }

    // Calculate Profit
    function calculateProfit(campaign) {
        const revenue = campaign.revenue || 0;
        const spend = campaign.spend || 0;
        return revenue - spend;
    }

    // Toggle campaign status via switch
    function toggleCampaignSwitch(campaignId, isActive) {
        const newStatus = isActive ? 'ACTIVE' : 'PAUSED';
        const toggle = event.target;
        const originalChecked = !isActive; // Store the opposite of current state

        // Disable the toggle during the request
        toggle.disabled = true;

        fetch(`/dashboard/api/toggle-campaign/${campaignId}/${newStatus}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the campaign in our local data
                    const campaign = allCampaigns.find(c => c.id === campaignId);
                    if (campaign) {
                        campaign.status = newStatus;
                        // Clear cache since campaign status changed
                        clearCampaignsCache();
                        filterCampaigns(); // Re-render with current filters

                        // INSTANT UPDATE: Update campaign stats immediately with FILTERED campaigns
                        const filteredCampaigns = getFilteredCampaigns();
                        updateCampaignStats(filteredCampaigns);
                        console.log(`📊 INSTANT STATS UPDATE: Campaign ${campaignId} status changed to ${newStatus}`);
                    }

                    // INSTANT RULE CHECK: Trigger immediate rule check and refresh
                    console.log(`⚡ INSTANT CHECK: Campaign ${campaignId} status changed to ${newStatus}`);

                    // Trigger instant rule check for all campaigns
                    fetch('/dashboard/api/campaigns/instant-rule-check', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('⚡ Instant rule check triggered');
                        }
                    })
                    .catch(error => {
                        console.error('⚡ Instant rule check error:', error);
                    });

                    // Check for rule actions after a very short delay
                    setTimeout(() => {
                        console.log('⚡ Checking for instant rule actions...');
                        autoRefreshWithFilters(); // Check for rule actions immediately
                    }, 500); // Wait only 0.5 seconds for backend rule processing

                    // Check again after 2 seconds to catch any delayed actions
                    setTimeout(() => {
                        console.log('⚡ Second check for rule actions...');
                        autoRefreshWithFilters();
                    }, 2000);

                } else {
                    // Revert toggle state on error
                    toggle.checked = originalChecked;
                    alert('Error: ' + (data.error || 'Failed to update campaign'));
                }
            })
            .catch(error => {
                console.error('Error toggling campaign:', error);
                // Revert toggle state on error
                toggle.checked = originalChecked;
                alert('Error updating campaign status');
            })
            .finally(() => {
                toggle.disabled = false;
            });
    }





    // Toggle campaign details dropdown
    function toggleCampaignDetails(campaignId) {
        // Prevent event bubbling to avoid conflicts with action buttons
        if (event.target.closest('.campaign-actions')) {
            return;
        }

        const detailsRow = document.getElementById(`details-${campaignId}`);
        const expandIcon = document.getElementById(`expand-${campaignId}`);

        if (detailsRow.classList.contains('show')) {
            detailsRow.classList.remove('show');
            expandIcon.classList.remove('expanded');
        } else {
            detailsRow.classList.add('show');
            expandIcon.classList.add('expanded');
            // Load rules dropdown for this campaign
            loadRulesDropdown(campaignId);
        }
    }

    // Load rules dropdown for campaign
    function loadRulesDropdown(campaignId) {
        // Load available rules
        fetch('/dashboard/api/rules/list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateRulesDropdown(campaignId, data.rules);
                }
            })
            .catch(error => {
                console.error('Error loading rules:', error);
            });

        // Load assigned rules
        loadAssignedRules(campaignId);
    }

    // Populate rules dropdown
    function populateRulesDropdown(campaignId, rules) {
        const select = document.getElementById(`rules-select-${campaignId}`);
        if (!select) return;

        // Clear existing options except the first one
        select.innerHTML = '<option value="">Select a rule to assign...</option>';

        rules.forEach(rule => {
            const option = document.createElement('option');
            option.value = rule.id;
            option.textContent = `${rule.name} (Payout: $${rule.payout})`;
            select.appendChild(option);
        });
    }

    // Load assigned rules for campaign
    function loadAssignedRules(campaignId) {
        fetch(`/dashboard/api/campaigns/${campaignId}/rules`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayAssignedRules(campaignId, data.rules);
                }
            })
            .catch(error => {
                console.error('Error loading assigned rules:', error);
            });
    }

    // Display assigned rules
    function displayAssignedRules(campaignId, rules) {
        const container = document.getElementById(`assigned-rules-${campaignId}`);
        if (!container) return;

        if (rules.length === 0) {
            container.innerHTML = '<span style="color: #64748b; font-size: 12px;">No rules assigned</span>';
            return;
        }

        container.innerHTML = rules.map(rule => `
            <div class="assigned-rule-tag">
                <span>${rule.name}</span>
                <button class="remove-rule-btn" onclick="removeRuleFromCampaign('${campaignId}', '${rule.id}')" title="Remove rule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }

    // Assign selected rule to campaign
    function assignSelectedRule(campaignId) {
        const select = document.getElementById(`rules-select-${campaignId}`);
        const button = document.getElementById(`assign-btn-${campaignId}`);

        if (!select.value) {
            alert('Please select a rule to assign');
            return;
        }

        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Assigning...';
        button.disabled = true;

        fetch(`/dashboard/api/rules/assign/${campaignId}/${select.value}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reset dropdown
                    select.value = '';
                    // Reload assigned rules
                    loadAssignedRules(campaignId);
                    // Show success message
                    console.log('Rule assigned successfully');
                } else {
                    alert('Error: ' + (data.error || 'Failed to assign rule'));
                }
            })
            .catch(error => {
                console.error('Error assigning rule:', error);
                alert('Error assigning rule');
            })
            .finally(() => {
                button.innerHTML = originalHTML;
                button.disabled = false;
            });
    }

    // Remove rule from campaign
    function removeRuleFromCampaign(campaignId, ruleId) {
        if (!confirm('Are you sure you want to remove this rule from the campaign?')) {
            return;
        }

        fetch(`/dashboard/api/rules/remove/${campaignId}/${ruleId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload assigned rules
                    loadAssignedRules(campaignId);
                    console.log('Rule removed successfully');
                } else {
                    alert('Error: ' + (data.error || 'Failed to remove rule'));
                }
            })
            .catch(error => {
                console.error('Error removing rule:', error);
                alert('Error removing rule');
            });
    }


</script>
{% endblock %}
